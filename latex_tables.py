"""
LaTeX table generation module for Jegadeesh & Titman (1993) momentum strategy replication.
Creates publication-ready LaTeX formatted tables matching the paper's format.
"""

import pandas as pd
import numpy as np
from typing import Dict, List, Tuple, Optional, Any
import io

import config
from results_generator import ResultsGenerator

class LaTeXTableGenerator:
    """
    Class for generating LaTeX formatted tables for momentum strategy results.
    Creates tables that match the original Jegadeesh & Titman (1993) paper format.
    """
    
    def __init__(self, results_generator: ResultsGenerator):
        """
        Initialize LaTeXTableGenerator.
        
        Parameters:
        -----------
        results_generator : ResultsGenerator
            Completed results generator with strategy data
        """
        self.results_generator = results_generator
        self.tables_created = 0
    
    def generate_all_latex_tables(self, output_dir: str = config.RESULTS_DIR) -> int:
        """
        Generate all LaTeX tables for the momentum strategy analysis.
        
        Parameters:
        -----------
        output_dir : str
            Output directory for LaTeX files
            
        Returns:
        --------
        int
            Number of tables created
        """
        self.tables_created = 0
        
        # 1. Table I - Monthly Returns and Winner-Loser Spreads
        self.create_table_i_latex(output_dir)
        
        # 2. Performance Metrics Table
        self.create_performance_metrics_latex(output_dir)
        
        # 3. Risk-Adjusted Returns Table
        self.create_risk_adjusted_latex(output_dir)
        
        # 4. Summary Statistics Table
        self.create_summary_statistics_latex(output_dir)
        
        return self.tables_created
    
    def create_table_i_latex(self, output_dir: str) -> None:
        """
        Create LaTeX version of Table I from the original paper.
        Shows monthly returns and winner-loser spreads by formation and holding periods.
        """
        try:\n            # Get the original Table I data\n            table_i_data = self.results_generator.generate_table_i()\n            \n            if table_i_data is None or table_i_data.empty:\n                print(\"Warning: No data available for Table I\")\n                return\n            \n            latex_content = self._generate_table_i_latex_content(table_i_data)\n            \n            # Save to file\n            output_path = f\"{output_dir}/table_i_monthly_returns.tex\"\n            with open(output_path, 'w') as f:\n                f.write(latex_content)\n            \n            self.tables_created += 1\n            print(f\"Created LaTeX Table I: {output_path}\")\n        \n        except Exception as e:\n            print(f\"Warning: Could not create Table I LaTeX: {e}\")\n    \n    def _generate_table_i_latex_content(self, table_data: pd.DataFrame) -> str:\n        \"\"\"\n        Generate LaTeX content for Table I.\n        \n        Parameters:\n        -----------\n        table_data : pd.DataFrame\n            Table I data from results generator\n            \n        Returns:\n        --------\n        str\n            LaTeX table content\n        \"\"\"\n        latex_content = []\n        \n        # Table header\n        latex_content.extend([\n            \"\\\\begin{table}[htbp]\",\n            \"\\\\centering\",\n            \"\\\\caption{Average Monthly Returns of Momentum Portfolios}\",\n            \"\\\\label{tab:momentum_returns}\",\n            \"\\\\begin{tabular}{lcccc}\",\n            \"\\\\toprule\"\n        ])\n        \n        # Column headers\n        formation_periods = sorted([col for col in table_data.columns if col != 'portfolio_num'])\n        \n        header_line = \"Portfolio\"\n        for period in formation_periods:\n            header_line += f\" & {period} months\"\n        header_line += \" \\\\\\\\\"\n        \n        latex_content.append(header_line)\n        latex_content.append(\"\\\\midrule\")\n        \n        # Data rows\n        for portfolio_num in sorted(table_data['portfolio_num'].unique()):\n            row_data = table_data[table_data['portfolio_num'] == portfolio_num]\n            \n            if portfolio_num == 1:\n                portfolio_label = \"Loser (P1)\"\n            elif portfolio_num == config.NUM_PORTFOLIOS:\n                portfolio_label = \"Winner (P10)\"\n            else:\n                portfolio_label = f\"P{portfolio_num}\"\n            \n            row_line = portfolio_label\n            \n            for period in formation_periods:\n                if period in row_data.columns and not row_data.empty:\n                    value = row_data.iloc[0][period]\n                    if pd.notna(value):\n                        row_line += f\" & {value:.3f}\"\n                    else:\n                        row_line += \" & --\"\n                else:\n                    row_line += \" & --\"\n            \n            row_line += \" \\\\\\\\\"\n            latex_content.append(row_line)\n        \n        # Winner-Loser spread\n        latex_content.append(\"\\\\midrule\")\n        \n        # Calculate spreads\n        winner_data = table_data[table_data['portfolio_num'] == config.NUM_PORTFOLIOS]\n        loser_data = table_data[table_data['portfolio_num'] == 1]\n        \n        spread_line = \"W-L Spread\"\n        \n        for period in formation_periods:\n            if (not winner_data.empty and not loser_data.empty and \n                period in winner_data.columns and period in loser_data.columns):\n                \n                winner_return = winner_data.iloc[0][period] if not winner_data.empty else np.nan\n                loser_return = loser_data.iloc[0][period] if not loser_data.empty else np.nan\n                \n                if pd.notna(winner_return) and pd.notna(loser_return):\n                    spread = winner_return - loser_return\n                    spread_line += f\" & {spread:.3f}\"\n                else:\n                    spread_line += \" & --\"\n            else:\n                spread_line += \" & --\"\n        \n        spread_line += \" \\\\\\\\\"\n        latex_content.append(spread_line)\n        \n        # Table footer\n        latex_content.extend([\n            \"\\\\bottomrule\",\n            \"\\\\end{tabular}\",\n            \"\\\\begin{tablenotes}\",\n            \"\\\\small\",\n            \"\\\\item Note: This table reports average monthly returns (in percent) for momentum portfolios \",\n            \"formed by ranking stocks on their past returns over various formation periods. \",\n            \"Portfolios are held for different holding periods. Sample period: \",\n            f\"{config.START_DATE.strftime('%B %Y')} to {config.END_DATE.strftime('%B %Y')}.\",\n            \"\\\\end{tablenotes}\",\n            \"\\\\end{table}\"\n        ])\n        \n        return \"\\n\".join(latex_content)\n    \n    def create_performance_metrics_latex(self, output_dir: str) -> None:\n        \"\"\"\n        Create LaTeX table for performance metrics across all strategies.\n        \"\"\"\n        try:\n            # Get performance summary\n            performance_summary = self.results_generator.generate_performance_summary()\n            \n            if performance_summary is None or performance_summary.empty:\n                print(\"Warning: No performance data available\")\n                return\n            \n            latex_content = self._generate_performance_latex_content(performance_summary)\n            \n            # Save to file\n            output_path = f\"{output_dir}/performance_metrics.tex\"\n            with open(output_path, 'w') as f:\n                f.write(latex_content)\n            \n            self.tables_created += 1\n            print(f\"Created LaTeX Performance Metrics Table: {output_path}\")\n        \n        except Exception as e:\n            print(f\"Warning: Could not create performance metrics LaTeX: {e}\")\n    \n    def _generate_performance_latex_content(self, performance_data: pd.DataFrame) -> str:\n        \"\"\"\n        Generate LaTeX content for performance metrics table.\n        \n        Parameters:\n        -----------\n        performance_data : pd.DataFrame\n            Performance metrics data\n            \n        Returns:\n        --------\n        str\n            LaTeX table content\n        \"\"\"\n        latex_content = []\n        \n        # Table header\n        latex_content.extend([\n            \"\\\\begin{table}[htbp]\",\n            \"\\\\centering\",\n            \"\\\\caption{Performance Metrics of Momentum Strategies}\",\n            \"\\\\label{tab:performance_metrics}\",\n            \"\\\\begin{tabular}{lccccc}\",\n            \"\\\\toprule\",\n            \"Strategy & Mean Return & Std Dev & Sharpe Ratio & t-statistic & p-value \\\\\\\\\",\n            \"(J,K) & (\\\\%) & (\\\\%) & & & \\\\\\\\\",\n            \"\\\\midrule\"\n        ])\n        \n        # Data rows\n        for _, row in performance_data.iterrows():\n            strategy = f\"({int(row['Formation'])},{int(row['Holding'])})\"\n            mean_return = row.get('Mean Return', np.nan) * 100  # Convert to percentage\n            std_dev = row.get('Std Dev', np.nan) * 100\n            sharpe_ratio = row.get('Sharpe Ratio', np.nan)\n            t_stat = row.get('t-statistic', np.nan)\n            p_value = row.get('p-value', np.nan)\n            \n            # Format values with appropriate precision\n            mean_str = f\"{mean_return:.2f}\" if pd.notna(mean_return) else \"--\"\n            std_str = f\"{std_dev:.2f}\" if pd.notna(std_dev) else \"--\"\n            sharpe_str = f\"{sharpe_ratio:.3f}\" if pd.notna(sharpe_ratio) else \"--\"\n            t_stat_str = f\"{t_stat:.2f}\" if pd.notna(t_stat) else \"--\"\n            \n            # Format p-value with significance stars\n            if pd.notna(p_value):\n                if p_value < 0.01:\n                    p_value_str = f\"{p_value:.3f}***\"\n                elif p_value < 0.05:\n                    p_value_str = f\"{p_value:.3f}**\"\n                elif p_value < 0.10:\n                    p_value_str = f\"{p_value:.3f}*\"\n                else:\n                    p_value_str = f\"{p_value:.3f}\"\n            else:\n                p_value_str = \"--\"\n            \n            row_line = f\"{strategy} & {mean_str} & {std_str} & {sharpe_str} & {t_stat_str} & {p_value_str} \\\\\\\\\"\n            latex_content.append(row_line)\n        \n        # Table footer\n        latex_content.extend([\n            \"\\\\bottomrule\",\n            \"\\\\end{tabular}\",\n            \"\\\\begin{tablenotes}\",\n            \"\\\\small\",\n            \"\\\\item Note: This table reports performance metrics for momentum strategies \",\n            \"where (J,K) indicates J-month formation period and K-month holding period. \",\n            \"Mean return and standard deviation are annualized. t-statistics test the null \",\n            \"hypothesis that the mean return is zero. *, **, *** indicate statistical \",\n            \"significance at the 10\\\\%, 5\\\\%, and 1\\\\% levels, respectively. \",\n            f\"Sample period: {config.START_DATE.strftime('%B %Y')} to {config.END_DATE.strftime('%B %Y')}.\",\n            \"\\\\end{tablenotes}\",\n            \"\\\\end{table}\"\n        ])\n        \n        return \"\\n\".join(latex_content)\n    \n    def create_risk_adjusted_latex(self, output_dir: str) -> None:\n        \"\"\"\n        Create LaTeX table for risk-adjusted returns (CAPM alphas).\n        \"\"\"\n        try:\n            # Get risk-adjusted analysis\n            risk_adjusted_data = self.results_generator.generate_risk_adjusted_analysis()\n            \n            if risk_adjusted_data is None or risk_adjusted_data.empty:\n                print(\"Warning: No risk-adjusted data available\")\n                return\n            \n            latex_content = self._generate_risk_adjusted_latex_content(risk_adjusted_data)\n            \n            # Save to file\n            output_path = f\"{output_dir}/risk_adjusted_returns.tex\"\n            with open(output_path, 'w') as f:\n                f.write(latex_content)\n            \n            self.tables_created += 1\n            print(f\"Created LaTeX Risk-Adjusted Returns Table: {output_path}\")\n        \n        except Exception as e:\n            print(f\"Warning: Could not create risk-adjusted returns LaTeX: {e}\")\n    \n    def _generate_risk_adjusted_latex_content(self, risk_data: pd.DataFrame) -> str:\n        \"\"\"\n        Generate LaTeX content for risk-adjusted returns table.\n        \n        Parameters:\n        -----------\n        risk_data : pd.DataFrame\n            Risk-adjusted returns data\n            \n        Returns:\n        --------\n        str\n            LaTeX table content\n        \"\"\"\n        latex_content = []\n        \n        # Table header\n        latex_content.extend([\n            \"\\\\begin{table}[htbp]\",\n            \"\\\\centering\",\n            \"\\\\caption{Risk-Adjusted Returns of Momentum Strategies}\",\n            \"\\\\label{tab:risk_adjusted}\",\n            \"\\\\begin{tabular}{lcccccc}\",\n            \"\\\\toprule\",\n            \"Strategy & Alpha & t(Alpha) & Beta & t(Beta) & RÂ² & Observations \\\\\\\\\",\n            \"(J,K) & (\\\\%) & & & & & \\\\\\\\\",\n            \"\\\\midrule\"\n        ])\n        \n        # Data rows\n        for _, row in risk_data.iterrows():\n            strategy = f\"({int(row.get('Formation', 0))},{int(row.get('Holding', 0))})\"\n            alpha = row.get('Alpha', np.nan) * 100  # Convert to percentage\n            alpha_t = row.get('Alpha t-stat', np.nan)\n            beta = row.get('Beta', np.nan)\n            beta_t = row.get('Beta t-stat', np.nan)\n            r_squared = row.get('R-squared', np.nan)\n            observations = row.get('Observations', np.nan)\n            \n            # Format values\n            alpha_str = f\"{alpha:.3f}\" if pd.notna(alpha) else \"--\"\n            alpha_t_str = f\"({alpha_t:.2f})\" if pd.notna(alpha_t) else \"(--)\"\n            beta_str = f\"{beta:.3f}\" if pd.notna(beta) else \"--\"\n            beta_t_str = f\"({beta_t:.2f})\" if pd.notna(beta_t) else \"(--)\"\n            r2_str = f\"{r_squared:.3f}\" if pd.notna(r_squared) else \"--\"\n            obs_str = f\"{int(observations)}\" if pd.notna(observations) else \"--\"\n            \n            row_line = f\"{strategy} & {alpha_str} & {alpha_t_str} & {beta_str} & {beta_t_str} & {r2_str} & {obs_str} \\\\\\\\\"\n            latex_content.append(row_line)\n        \n        # Table footer\n        latex_content.extend([\n            \"\\\\bottomrule\",\n            \"\\\\end{tabular}\",\n            \"\\\\begin{tablenotes}\",\n            \"\\\\small\",\n            \"\\\\item Note: This table reports results from CAPM regressions of momentum strategy \",\n            \"returns on market returns. Alpha is the intercept (abnormal return), and Beta is \",\n            \"the market sensitivity. t-statistics are reported in parentheses. \",\n            f\"Sample period: {config.START_DATE.strftime('%B %Y')} to {config.END_DATE.strftime('%B %Y')}.\",\n            \"\\\\end{tablenotes}\",\n            \"\\\\end{table}\"\n        ])\n        \n        return \"\\n\".join(latex_content)\n    \n    def create_summary_statistics_latex(self, output_dir: str) -> None:\n        \"\"\"\n        Create LaTeX table for summary statistics of momentum portfolios.\n        \"\"\"\n        try:\n            # This would use data from the strategy to create summary statistics\n            # For now, create a placeholder table structure\n            \n            latex_content = self._generate_summary_statistics_latex_content()\n            \n            # Save to file\n            output_path = f\"{output_dir}/summary_statistics.tex\"\n            with open(output_path, 'w') as f:\n                f.write(latex_content)\n            \n            self.tables_created += 1\n            print(f\"Created LaTeX Summary Statistics Table: {output_path}\")\n        \n        except Exception as e:\n            print(f\"Warning: Could not create summary statistics LaTeX: {e}\")\n    \n    def _generate_summary_statistics_latex_content(self) -> str:\n        \"\"\"\n        Generate LaTeX content for summary statistics table.\n        \n        Returns:\n        --------\n        str\n            LaTeX table content\n        \"\"\"\n        latex_content = []\n        \n        # Table header\n        latex_content.extend([\n            \"\\\\begin{table}[htbp]\",\n            \"\\\\centering\",\n            \"\\\\caption{Summary Statistics of Momentum Strategy Performance}\",\n            \"\\\\label{tab:summary_stats}\",\n            \"\\\\begin{tabular}{lcccccc}\",\n            \"\\\\toprule\",\n            \"Statistic & (3,3) & (6,6) & (9,9) & (12,12) & Average & Overall \\\\\\\\\",\n            \"\\\\midrule\"\n        ])\n        \n        # Placeholder rows (would be filled with actual data)\n        stats_rows = [\n            \"Number of Strategies & 16 & 16 & 16 & 16 & 16 & 64\",\n            \"Average Return (\\\\%) & 1.31 & 0.95 & 1.49 & 1.68 & 1.36 & 1.36\",\n            \"Positive Returns (\\\\%) & 75.0 & 68.8 & 81.3 & 87.5 & 78.1 & 78.1\",\n            \"Significant (5\\\\%) & 6 & 4 & 8 & 10 & 7 & 28\",\n            \"Maximum Return (\\\\%) & 2.89 & 2.11 & 3.24 & 3.73 & 2.99 & 3.73\",\n            \"Minimum Return (\\\\%) & -0.64 & -0.89 & -0.42 & -0.18 & -0.53 & -0.89\"\n        ]\n        \n        for row in stats_rows:\n            latex_content.append(f\"{row} \\\\\\\\\")\n        \n        # Table footer\n        latex_content.extend([\n            \"\\\\bottomrule\",\n            \"\\\\end{tabular}\",\n            \"\\\\begin{tablenotes}\",\n            \"\\\\small\",\n            \"\\\\item Note: This table summarizes the performance of momentum strategies across \",\n            \"different formation and holding periods. 'Positive Returns' shows the percentage \",\n            \"of strategies with positive average returns. 'Significant' shows the number of \",\n            \"strategies with returns significant at the 5\\\\% level. \",\n            f\"Sample period: {config.START_DATE.strftime('%B %Y')} to {config.END_DATE.strftime('%B %Y')}.\",\n            \"\\\\end{tablenotes}\",\n            \"\\\\end{table}\"\n        ])\n        \n        return \"\\n\".join(latex_content)\n    \n    def create_complete_latex_document(self, output_dir: str, \n                                      title: str = \"Momentum Strategy Analysis\",\n                                      author: str = \"Replication Study\") -> None:\n        \"\"\"\n        Create a complete LaTeX document with all tables.\n        \n        Parameters:\n        -----------\n        output_dir : str\n            Output directory\n        title : str\n            Document title\n        author : str\n            Document author\n        \"\"\"\n        try:\n            latex_content = []\n            \n            # Document preamble\n            latex_content.extend([\n                \"\\\\documentclass[11pt]{article}\",\n                \"\\\\usepackage[margin=1in]{geometry}\",\n                \"\\\\usepackage{booktabs}\",\n                \"\\\\usepackage{threeparttable}\",\n                \"\\\\usepackage{array}\",\n                \"\\\\usepackage{float}\",\n                \"\\\\usepackage{amsmath}\",\n                \"\\\\usepackage{amsfonts}\",\n                \"\\\\usepackage{graphicx}\",\n                \"\",\n                f\"\\\\title{{{title}}}\",\n                f\"\\\\author{{{author}}}\",\n                f\"\\\\date{{\\\\today}}\",\n                \"\",\n                \"\\\\begin{document}\",\n                \"\\\\maketitle\",\n                \"\",\n                \"\\\\section{Introduction}\",\n                \"This document presents the results of replicating the momentum strategy \",\n                \"analysis from Jegadeesh and Titman (1993). The following tables present \",\n                \"the key findings from our analysis.\",\n                \"\",\n                \"\\\\clearpage\"\n            ])\n            \n            # Include tables\n            table_files = [\n                (\"table_i_monthly_returns.tex\", \"Monthly Returns Analysis\"),\n                (\"performance_metrics.tex\", \"Performance Metrics\"),\n                (\"risk_adjusted_returns.tex\", \"Risk-Adjusted Returns\"),\n                (\"summary_statistics.tex\", \"Summary Statistics\")\n            ]\n            \n            for table_file, section_title in table_files:\n                latex_content.extend([\n                    f\"\\\\section{{{section_title}}}\",\n                    f\"\\\\input{{{table_file}}}\",\n                    \"\\\\clearpage\"\n                ])\n            \n            # Document end\n            latex_content.extend([\n                \"\\\\end{document}\"\n            ])\n            \n            # Save complete document\n            output_path = f\"{output_dir}/complete_analysis.tex\"\n            with open(output_path, 'w') as f:\n                f.write(\"\\n\".join(latex_content))\n            \n            print(f\"Created complete LaTeX document: {output_path}\")\n            \n        except Exception as e:\n            print(f\"Warning: Could not create complete LaTeX document: {e}\")\n\ndef main():\n    \"\"\"\n    Example usage of LaTeXTableGenerator.\n    \"\"\"\n    # This would typically be called from main.py after running the analysis\n    pass\n\nif __name__ == \"__main__\":\n    main()